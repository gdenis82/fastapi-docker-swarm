# Инфраструктура FastAPI в Docker Swarm (3 ноды)

Данный проект настроен для автоматического развертывания отказоустойчивого приложения FastAPI в кластере Docker Swarm из 3-х нод.

## Автоматический деплой

Для полной автоматизации процесса (настройка firewall, инициализация кластера, метки, секреты, сборка и деплой) используйте скрипт `automate_deploy.py`.

### 1. Настройка конфигурации
Отредактируйте файл `inventory.json`, указав IP-адреса ваших нод, пользователей и пути к SSH-ключам.

```json
{
  "manager": {
    "ip": "85.198.86.165",
    "user": "root",
    "key_path": "C:\\path\\to\\key",
    "password": ""
  },
  "workers": [
    { "hostname": "worker-1", "ip": "155.212.146.21", "user": "root", "key_path": "C:\\path\\to\\key" },
    { "hostname": "worker-2", "ip": "85.198.102.85", "user": "root", "key_path": "C:\\path\\to\\key" }
  ],
  "registry": "85.198.86.165:5000",
  "stack_name": "fastapi_stack",
  "app_secret": "your_secret_here"
}
```

### 2. Запуск деплоя
Запустите скрипт на вашей локальной машине:
```bash
python automate_deploy.py
```

Скрипт выполнит:
1. Настройку Firewall на всех нодах через SSH (включая порты для Swarm, Portainer, Registry и приложения на 8080).
2. Настройку и запуск локального Docker Registry на Manager ноде.
3. Инициализацию Docker Swarm на Manager.
4. Присоединение Worker нод к кластеру.
5. Установку меток (`node.labels.type=worker`).
6. Создание Docker Secrets.
7. Сборку Docker-образа и его Push в локальный Registry.
8. Деплой стека с использованием `docker-compose.yml`.
9. Установку Portainer для мониторинга.

### Важное примечание по Registry
Локальный Registry работает по протоколу HTTP (без SSL), поэтому Docker по умолчанию блокирует подключение к нему из соображений безопасности. 

**Вам НЕОБХОДИМО выполнить следующие действия:**

1. **На вашей локальной машине (Windows/Mac/Linux):**
   - Если вы используете **Docker Desktop**: зайдите в `Settings` -> `Docker Engine`.
   - Добавьте IP вашего менеджера в список `insecure-registries`:
     ```json
     {
       "insecure-registries": ["85.198.86.165:5000"]
     }
     ```
   - Нажмите `Apply & Restart`.
   - **Без этого шага команда `docker push` завершится ошибкой.**

2. **На серверах (нодах):**
   - Скрипт `automate_deploy.py` пытается настроить это автоматически в файле `/etc/docker/daemon.json` и перезапустить Docker.
   - Если деплой все равно не видит образы, проверьте содержимое файла на нодах вручную.

## Особенности реализации пайплайна

Пайплайн автоматизации (`automate_deploy.py`) спроектирован с учетом требований безопасности и отказоустойчивости. Ниже приведен разбор ключевых решений:

### 1. Отказоустойчивый Docker Registry
*   **Реализация**: Реестр развернут как `docker service create` с ограничением на запуск только на менеджер-ноде.
*   **Почему так**: В отличие от обычного контейнера (`docker run`), Swarm-сервис автоматически перезапустится при сбое. Использование именованного тома `registry_data` гарантирует, что ваши образы не исчезнут при перезагрузке сервера.
*   **Безопасность**: Внедрена Basic Auth. Доступ к реестру (push/pull) возможен только по логину и паролю из `inventory.json`.

### 2. Безопасная работа с секретами
*   **Реализация**: Секреты создаются через `stdin` (стандартный ввод) SSH-сессии.
*   **Почему так**: Мы отказались от команды `echo "pass" | docker secret create`, так как она оставляет пароль в истории команд (`.bash_history`) и списке процессов (`ps aux`). Передача через stdin полностью исключает утечку секрета в логи системы.

### 3. Zero Downtime Deployment (ZDD)
*   **Реализация**: В `docker-compose.yml` установлены параметры `update_config` с `order: start-first`.
*   **Почему так**: Swarm сначала запускает новый контейнер и ждет, пока он пройдет проверку `healthcheck`. Только после того, как новая версия подтвердит свою работоспособность, старый контейнер будет остановлен. Это гарантирует отсутствие простоя при обновлении кода.

### 4. Уникальное тегирование образов
*   **Реализация**: Каждая сборка получает тег с временной меткой (например, `:20240522_193005`).
*   **Почему так**: Если использовать только тег `:latest`, Swarm может не заметить изменений в образе и не начать обновление. Уникальные теги гарантируют, что Swarm увидит новую версию и инициирует деплой.

### 5. Лимиты и резервирование ресурсов
*   **Реализация**: Для приложения жестко заданы `limits` (1GB RAM) и `reservations` (256MB RAM).
*   **Почему так**: Это защищает ноды от "прожорливых" процессов (Memory Leak). Лимиты не дают приложению уронить всю операционную систему, а резервирование гарантирует, что Swarm не попытается запустить контейнер там, где для него недостаточно ресурсов.

### 6. Изоляция и hardening Portainer
*   **Реализация**: Используется образ `portainer-ce` (вместо устаревшего `portainer`), внутренняя сеть `agent_network` с параметром `internal: true`, а также удален флаг `--tlsskipverify`.
*   **Почему так**: Версия Community Edition содержит патчи безопасности для уязвимостей 2023-2024 гг. Изоляция сети агентов и удаление флага небезопасной проверки TLS гарантируют, что к Docker API кластера сможет обращаться только сам Portainer, защищая трафик от прослушивания и вмешательства.

## Очистка инфраструктуры

Для очистки всех нод от предыдущих деплоев, неиспользуемых контейнеров и образов используйте скрипт `cleanup_nodes.py`:

```bash
# Обычная очистка (удаление стеков, секретов и prune системы)
python cleanup_nodes.py

# Полная очистка (включая выход из Docker Swarm на всех нодах)
python cleanup_nodes.py --full
```

## Ручная настройка (для справки)

## Особенности конфигурации

### Zero Downtime Deployment
В `docker-compose.yml` настроены параметры для бесшовного обновления:
- `order: start-first`: сначала запускается новый контейнер, затем останавливается старый.
- `healthcheck`: Swarm ждет, пока приложение станет `healthy` перед тем, как переключить трафик и остановить старую версию.
- `parallelism: 1`: обновление происходит по одной реплике за раз.

### Мониторинг (Portainer)
```bash
curl -L https://raw.githubusercontent.com/portainer/portainer-compose/master/docker-stack.yml -o portainer-agent-stack.yml
docker stack deploy -c portainer-agent-stack.yml portainer
```
Панель будет доступна на порту `9000` (старый интерфейс) или `9443` (зависит от версии). В используемом конфиге опубликован порт 9000.
Приложение доступно на порту `8080`.
